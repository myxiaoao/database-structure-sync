name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    name: Release (${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            arch: aarch64
            os: darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
            arch: x86_64
            os: darwin
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            arch: x86_64
            os: linux
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x86_64
            os: windows

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install dependencies
        run: npm ci

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Database Structure Sync ${{ github.ref_name }}"
          releaseBody: "See the assets to download this version and install."
          releaseDraft: true
          prerelease: false
          args: --target ${{ matrix.target }}
          updaterJsonPreferNsis: true

      - name: Upload updater artifacts
        uses: actions/upload-artifact@v4
        with:
          name: updater-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.tar.gz.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.rpm
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.app
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.nsis.zip
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.nsis.zip.sig
          retention-days: 1
          if-no-files-found: ignore

  assemble-latest-json:
    name: Assemble latest.json
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Generate latest.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ github.ref_name }}"
          NOTES="See the assets to download this version and install."
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Initialize platforms object
          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "${NOTES}",
            "pub_date": "${PUB_DATE}",
            "platforms": {}
          }
          EOF

          # Function to add platform entry
          add_platform() {
            local platform=$1
            local url=$2
            local sig=$3

            if [ -n "$sig" ]; then
              jq --arg platform "$platform" \
                 --arg url "$url" \
                 --arg sig "$sig" \
                 '.platforms[$platform] = {"url": $url, "signature": $sig}' \
                 latest.json > latest.json.tmp && mv latest.json.tmp latest.json
            fi
          }

          REPO="myxiaoao/database-structure-sync"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"

          # Find and process signature files
          echo "Searching for signature files..."
          find artifacts -name "*.sig" -type f | while read sigfile; do
            echo "Found: $sigfile"
            sig=$(cat "$sigfile" 2>/dev/null || echo "")
            basename=$(basename "$sigfile" .sig)

            case "$basename" in
              *.tar.gz)
                # macOS tarball
                if [[ "$sigfile" == *"darwin"* ]] || [[ "$sigfile" == *"macos"* ]]; then
                  if [[ "$sigfile" == *"aarch64"* ]] || [[ "$basename" == *"aarch64"* ]]; then
                    add_platform "darwin-aarch64" "${BASE_URL}/${basename}" "$sig"
                  elif [[ "$sigfile" == *"x86_64"* ]] || [[ "$basename" == *"x64"* ]]; then
                    add_platform "darwin-x86_64" "${BASE_URL}/${basename}" "$sig"
                  fi
                fi
                ;;
              *.AppImage)
                # Linux AppImage
                add_platform "linux-x86_64" "${BASE_URL}/${basename}" "$sig"
                ;;
              *.nsis.zip)
                # Windows NSIS installer
                add_platform "windows-x86_64" "${BASE_URL}/${basename}" "$sig"
                ;;
              *.msi)
                # Windows MSI (fallback if no NSIS)
                # Only add if windows platform not already set
                if ! jq -e '.platforms["windows-x86_64"]' latest.json > /dev/null 2>&1; then
                  add_platform "windows-x86_64" "${BASE_URL}/${basename}" "$sig"
                fi
                ;;
            esac
          done

          echo "Generated latest.json:"
          cat latest.json

      - name: Upload latest.json to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} latest.json --clobber
